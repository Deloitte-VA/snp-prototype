<!DOCTYPE html>
<html lang="en" ng-app="APP">
	<head>
		<meta charset="utf-8"> 
		<link rel="stylesheet" href="webjars/bootstrap/3.3.4/dist/css/bootstrap.min.css">
	</head>
	<body>
		<div class="container">
			<div class="row">
				<h1>Upload a File to a RESTful Web Service</h1>
			</div>
			<div class="row">
				<h3>(JAX-RS using Jersey)</h3>
			</div>
			<div class="row">
				<form ng-controller="uploader">
					<div class="row">
						<div class="col-xs-2">
							<div class="form-group">
								<select type="text" ng-model="contentType" ng-options="contentType for contentType in contentTypes"></select>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<input type="file" file-input="files" multiple />
								<li ng-repeat="file in files">{{file.name}}</li>
							</div>
						</div>
						<div class="col-xs-2">
							<div class="form-group">
								<button class="btn btn-default" ng-click="upload()"><span class="glyphicon glyphicon-upload"></span>Upload</button>
							</div>							
						</div>
					</div>
				</form>
			</div>
		</div>
		
		<script type="text/javascript" src="webjars/angularjs/1.3.15/angular.min.js"></script>
		
		<script>
			angular.module('APP', []).
			directive('fileInput', ['$parse', function($parse){
				return {
					restrict:'A',
					link:function(scope, elm, attrs) {
						elm.bind('change', function() {
							$parse(attrs.fileInput)
							.assign(scope, elm[0].files)
							scope.$apply()
						})
					}
				}
			}]).
			controller('uploader', ['$scope', '$http',
				function($scope, $http) {
				$scope.contentTypes = 
					[
						'LEGO',
						'FHIR'
					];
					$scope.filesChanged = function(elm) {
						$scope.files = elm.files;
						$scope.$apply();
					}
					$scope.upload = function() {
						var fd = new FormData();
						
						if($scope.contentType == 'LEGO') {
							var blob = new Blob([], {type: 'application/lego+xml'});
							fd.append('file', blob, 'LEGO');
						} else if($scope.contentType == 'FIHR') {
							var blob = new Blob([], {type: 'application/fhir+xml'});
							fd.append('file', blob, 'FIHR');
						}
						
						angular.forEach($scope.files, function(file) {
							fd.append('file', file);
						})
						$http.post('services/classifier', fd,
						{
							transformRequest:angular.identity,
							headers:{'Content-Type':undefined}
						})
						.success(function(d) {
							console.log(d)	
						})
					}
				}
			])
		</script>
	</body>
</html>